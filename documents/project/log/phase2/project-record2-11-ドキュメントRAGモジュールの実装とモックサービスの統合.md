---
title: "ドキュメントRAGモジュールの実装とモックサービスの統合"
date: "2025-03-19"
author: "HARCA開発チーム"
phase: "Phase2"
record_number: 11
tags: ["RAG", "ドキュメント処理", "モックサービス", "ベクトルストア", "キャッシュ"]
---

# ドキュメントRAGモジュールの実装とモックサービスの統合

## 概要

HARCAプロジェクトのドキュメント（特にプロジェクト記録）をRAG化するための専用モジュールを`/modules/document-rag`に実装しました。このモジュールはESモジュールのインポート問題を回避するために、モックサービスを使用して実装されています。

## 実装の背景と目的

HARCAプロジェクトでは、プロジェクト記録や技術ドキュメントなどの内部文書を効率的に検索・活用するためのRAG（Retrieval Augmented Generation）機能が必要とされていました。既存のHARCAベクトルストアとキャッシュシステムを活用する予定でしたが、ESモジュールのインポート問題が発生したため、一時的な解決策としてモックサービスを実装することになりました。

## 実装内容

### 1. モックサービスの実装

ESモジュールのインポート問題を回避するために、以下のモックサービスを実装しました：

- **MockVectorStore**: 実際のベクトルストアの代わりに使用するモックサービス
- **MockCacheService**: 実際のキャッシュシステムの代わりに使用するモックサービス

これらのモックサービスは、本番環境のHARCAコンポーネントと同等の機能を提供し、将来的に実サービスに置き換えることを前提に設計されています。

### 2. 主要コンポーネント

RAGモジュールは以下の主要コンポーネントから構成されています：

- **DocumentProcessor**: ドキュメントの読み込み、チャンク分割、メタデータ抽出を担当
- **DocumentVectorStore**: ベクトルの保存と検索を担当（内部でMockVectorStoreを使用）
- **CacheService**: 埋め込みのキャッシュ管理を担当（内部でMockCacheServiceを使用）
- **EmbeddingService**: OpenAIモデルを使用した埋め込み生成を担当
- **DocumentRAG**: 全体の調整とAPIを提供

### 3. ドキュメント処理機能

以下のドキュメント処理機能を実装しました：

- Markdownファイルの読み込みと解析
- Front Matterからのメタデータ抽出
- 適切なサイズでのチャンク分割（オーバーラップ対応）
- OpenAI埋め込みモデルを使用したベクトル化
- メタデータを活用した高度な検索機能

### 4. スクリプト

以下のスクリプトを実装しました：

- **process-documents.js**: ドキュメントの処理とベクトル化を行うスクリプト
- **search-documents.js**: ベクトル検索を使用してドキュメントを検索するスクリプト

## テスト結果

テスト用のMarkdownドキュメントを作成し、処理と検索機能をテストしました。結果は以下の通りです：

1. **ドキュメント処理**:
   - 3つのテストドキュメントが正常に処理され、7つのチャンクに分割されました
   - メタデータが正しく抽出されました
   - 埋め込みベクトルが生成され、モックベクトルストアに保存されました

2. **検索機能**:
   - 「ベクトルストアのパフォーマンス最適化」というクエリに対して、関連する3つのチャンクが検索されました
   - 「HARCAシステムのアーキテクチャと構成要素」というクエリに対して、関連する3つのチャンクが検索されました
   - 検索結果は類似度スコアでランク付けされ、適切に表示されました

## 今後の課題と改善点

1. **本番環境への統合**:
   - ESモジュールのインポート問題が解決した後、実際のHARCAベクトルストアとキャッシュシステムに接続
   - モックから実サービスへの移行をスムーズに行うための互換性確保

2. **機能拡張**:
   - メタデータフィルタリングの強化
   - 検索結果の関連性向上のためのパラメータ調整
   - ドキュメント更新時の差分処理の最適化

3. **パフォーマンス最適化**:
   - 大量のドキュメント処理時のバッチ処理の最適化
   - キャッシュ戦略の改善

## 技術的詳細

### ディレクトリ構造

```
/modules/document-rag/
├── config/
│   └── default.js         # 設定ファイル
├── scripts/
│   ├── process-documents.js # ドキュメント処理スクリプト
│   └── search-documents.js  # ドキュメント検索スクリプト
├── src/
│   ├── cache-service.js     # キャッシュサービス
│   ├── document-processor.js # ドキュメント処理
│   ├── document-rag.js      # メインモジュール
│   ├── document-vector-store.js # ベクトルストア
│   ├── embedding-service.js # 埋め込みサービス
│   ├── mock-cache-service.js # モックキャッシュ
│   └── mock-vector-store.js # モックベクトルストア
└── package.json           # 依存関係
```

### 使用技術

- **言語**: JavaScript (Node.js)
- **埋め込みモデル**: OpenAI Ada 002 / text-embedding-3-small
- **ドキュメント処理**: gray-matter, markdown-it
- **スケジューリング**: node-schedule

## まとめ

HARCAプロジェクトのドキュメントRAGモジュールを実装し、モックサービスを使用してESモジュールのインポート問題を回避しました。テスト結果から、ドキュメント処理と検索機能が正常に動作していることが確認できました。今後は、実際のHARCAコンポーネントとの統合や機能拡張を進めていく予定です。

このモジュールにより、HARCAプロジェクトの内部ドキュメントを効率的に検索・活用することが可能になり、プロジェクト全体の生産性向上に貢献することが期待されます。
