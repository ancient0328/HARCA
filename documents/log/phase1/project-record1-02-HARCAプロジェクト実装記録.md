# HARCAプロジェクト実装記録

## プロジェクト概要

HARCAプロジェクトをSupabaseと連携させ、Windsurfから利用できるようにする実装を行いました。このドキュメントでは、実装過程で実行した作業、発生した問題とその解決策、および得られた結果について記録します。

## 実行した作業

### 1. MCPサーバーの設定

MCPサーバーをSupabaseに接続するために、以下の作業を実施しました：

- `core/server.js`の修正
  - コマンドライン引数からデータベースURLを受け取るように変更
  - サーバー起動ロジックの調整

- `package.json`の更新
  - 環境変数からSupabase接続文字列を渡すスクリプトを追加
  - 診断用スクリプトの追加

### 2. Windsurfとの統合

Windsurfと連携するために、以下の作業を実施しました：

- Windsurf設定ファイルの作成
  - `~/.codeium/windsurf/mcp_config.json`の設定
  - pnpxコマンドを使用したMCPサーバー起動設定

- 統合モジュールの実装
  - `integrations/windsurf.js`の作成
  - 設定ファイル管理機能の実装

### 3. ベクトルストアの実装

コードベクトルを保存・検索するための機能を実装しました：

- `plugins/vector-store/index.js`の修正
  - シンプルなハッシュベースのベクトル生成機能
  - Supabaseへのデータ保存機能
  - ベクトル類似検索機能

### 4. サンプルデータの追加

テスト用のサンプルデータを追加するスクリプトを実装しました：

- `scripts/add-sample-data.js`の作成
  - 3つのJavaScriptコードサンプルの定義
  - ベクトル化と保存のロジック

## 発生した問題と解決策

### 1. モジュールのインポート問題

**問題**：`@modelcontextprotocol/server-postgres`パッケージが見つからないエラー

**解決策**：
- パッケージマネージャーとして`pnpm`を使用
- `pnpx`コマンドを使用してパッケージを実行

### 2. コマンドライン引数の問題

**問題**：サーバー起動時にデータベースURLが必要というエラー

**解決策**：
- `core/server.js`を修正してコマンドライン引数を処理
- `package.json`のスクリプトを更新して環境変数から接続文字列を渡すように設定

### 3. OpenAI API関連のエラー

**問題**：OpenAI APIの設定に関するTypeError

**解決策**：
- 一時的にOpenAI API機能を無効化
- シンプルなハッシュベースのベクトル生成機能を実装

### 4. Supabaseへの接続問題

**問題**：SSL証明書関連のエラー

**解決策**：
- 接続文字列にSSLモードパラメータを追加
- `?sslmode=no-verify`を使用して証明書検証をスキップ

### 5. ベクトルデータ形式の問題

**問題**：pgvectorがベクトルデータを受け付けないエラー

**解決策**：
- ベクトルデータを`[x,y,z]`形式の文字列に変換
- `::vector`キャストを使用してSQLクエリを構築

### 6. NaN値の問題

**問題**：ベクトルデータにNaN（非数）値が含まれるエラー

**解決策**：
- ベクトル生成関数にNaN値を検出して0に置き換えるロジックを追加
- ベクトルの正規化処理を改善

## 得られた結果

### 1. Supabaseとの連携

- Supabaseデータベースへの接続確立
- `code_vectors`テーブルへのデータ保存機能
- pgvector拡張機能を使用したベクトル検索

### 2. Windsurfとの統合

- Windsurfの設定ファイル作成
- MCPサーバーを通じたSupabaseへのアクセス
- Cascade AIアシスタントからのデータベース操作

### 3. サンプルデータ

- 3つのJavaScriptコードサンプルをデータベースに保存
- ベクトル検索のテストデータとして利用可能

## 今後の課題

### 1. OpenAI API統合の完成

- 現在は一時的なハッシュベースのベクトル生成を使用
- 将来的にはOpenAI APIを使用した高品質なベクトル生成に移行

### 2. ユーザーインターフェースの開発

- コード検索・管理のためのWebインターフェース
- 検索結果の可視化機能

### 3. 機能の拡張

- より多くのコードサンプルの追加
- 検索アルゴリズムの改善
- 多言語対応

## 使用方法

### Windsurfとの連携

1. Windsurfを起動
2. Cascadeアシスタントで「ハンマー（MCP）」アイコンをクリック
3. Supabaseに接続されていることを確認

### サンプルデータの追加

```bash
cd /Users/ancient0328/Development/MCPserver/HARCA/harca-mcp
node scripts/add-sample-data.js
```

### 診断の実行

```bash
cd /Users/ancient0328/Development/MCPserver/HARCA/harca-mcp
npm run diagnose
```

## まとめ

HARCAプロジェクトとSupabaseの連携、およびWindsurfとの統合が完了しました。コードベクトルの保存と検索が可能になり、AIアシスタントからデータベースを操作できるようになりました。今後は機能の拡張と改善を進めていくことで、より高度なコード検索・管理システムを構築していきます。
