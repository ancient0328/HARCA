---
title: "多階層記憶システム WebSocket API テスト"
date: "2025-03-23"
author: "HARCA開発チーム"
version: "1.0.0"
status: "ドラフト"
---

# 多階層記憶システム WebSocket API テスト

*作成日: 2025年3月23日*
*更新日: 2025年3月23日*

## 1. 概要

本ドキュメントでは、HARCA多階層記憶システムのWebSocket APIに対する統合テストについて詳細に記述します。WebSocket APIは、リアルタイムの記憶更新通知、ストリーミング検索、および対話型記憶操作を提供するために実装されています。このテストは、WebSocketプロトコルを介した双方向通信が設計通りに機能し、各記憶モジュールと適切に連携することを確認することを目的としています。

## 2. テスト対象

### 2.1 WebSocket APIコンポーネント

1. **接続管理**
   - 接続確立
   - 認証
   - 接続維持（ハートビート）
   - 接続終了

2. **メッセージ処理**
   - メッセージ形式
   - コマンド処理
   - イベント通知
   - エラー処理

3. **記憶操作**
   - 記憶作成・更新・削除
   - 記憶検索
   - 記憶昇格
   - 記憶ストリーミング

## 3. テスト環境

### 3.1 テスト環境構成

- **WebSocketサーバー**: Socket.IO v4.0+
- **データベース**:
  - Redis v7.0+ (短期記憶)
  - PostgreSQL v15.0+ (中期・長期記憶)
  - pgvector拡張 (ベクトル検索)
- **テストツール**:
  - Jest v29.0+
  - Socket.IO Client
  - WebSocket テストクライアント

### 3.2 テストデータ

- 各記憶層のテストデータ
- 様々なタイプとメタデータを持つ記憶データ
- リアルタイム更新シナリオ用のデータ

### 3.3 テスト前提条件

- WebSocketサーバーが稼働していること
- データベースが適切に初期化されていること
- テスト用の認証トークンが利用可能であること

## 4. 接続管理テスト

### 4.1 接続確立テスト

#### TC-WS-CONN-001: 基本接続確立

**目的**: WebSocketサーバーへの基本的な接続が確立できることを確認する

**テストステップ**:
1. WebSocketクライアントを初期化する
2. サーバーのエンドポイントに接続を試みる
3. 接続イベントを監視する

**期待結果**:
- 接続が正常に確立される
- クライアントが接続確認イベントを受信する
- サーバーが新しい接続を認識する

#### TC-WS-CONN-002: 認証付き接続確立

**目的**: 認証トークンを使用した接続が確立できることを確認する

**テストステップ**:
1. 有効な認証トークンを準備する
2. 認証トークンを含めてWebSocketサーバーに接続を試みる
3. 認証結果を監視する

**期待結果**:
- 接続が正常に確立される
- 認証が成功する
- クライアントが認証成功イベントを受信する

#### TC-WS-CONN-003: 無効な認証での接続試行

**目的**: 無効な認証トークンでの接続試行時のエラー処理を確認する

**テストステップ**:
1. 無効な認証トークンを準備する
2. 無効なトークンを含めてWebSocketサーバーに接続を試みる
3. エラーイベントを監視する

**期待結果**:
- 接続は確立されるが、認証は失敗する
- クライアントが認証失敗イベントを受信する
- 適切なエラーコードとメッセージが含まれている

### 4.2 接続維持テスト

#### TC-WS-CONN-004: ハートビートメカニズム

**目的**: 接続維持のためのハートビートメカニズムが機能することを確認する

**テストステップ**:
1. WebSocketサーバーに接続する
2. 30秒間何もメッセージを送信せずに待機する
3. ハートビートイベントを監視する

**期待結果**:
- 接続が維持される
- サーバーからのハートビートメッセージが受信される
- クライアントが自動的にハートビート応答を送信する

#### TC-WS-CONN-005: 接続タイムアウト

**目的**: ハートビート応答がない場合の接続タイムアウト処理を確認する

**テストステップ**:
1. WebSocketサーバーに接続する
2. ハートビート応答を無効化する
3. 接続タイムアウトイベントを監視する

**期待結果**:
- 一定時間後に接続がタイムアウトする
- クライアントが切断イベントを受信する
- サーバーが接続を終了する

### 4.3 接続終了テスト

#### TC-WS-CONN-006: クライアント主導の接続終了

**目的**: クライアントからの接続終了が適切に処理されることを確認する

**テストステップ**:
1. WebSocketサーバーに接続する
2. クライアントから切断コマンドを送信する
3. 切断イベントを監視する

**期待結果**:
- 接続が正常に終了する
- サーバーが切断を認識する
- リソースが適切に解放される

#### TC-WS-CONN-007: サーバー主導の接続終了

**目的**: サーバーからの接続終了が適切に処理されることを確認する

**テストステップ**:
1. WebSocketサーバーに接続する
2. サーバーに特定のクライアントを切断するよう指示する
3. 切断イベントを監視する

**期待結果**:
- 接続が正常に終了する
- クライアントが切断イベントを受信する
- 切断理由が適切に通知される

## 5. メッセージ処理テスト

### 5.1 メッセージ形式テスト

#### TC-WS-MSG-001: 標準メッセージ形式

**目的**: 標準メッセージ形式が正しく処理されることを確認する

**テストステップ**:
1. WebSocketサーバーに接続する
2. 以下の形式のメッセージを送信する:
   ```json
   {
     "type": "command",
     "command": "ping",
     "data": {},
     "id": "msg-001"
   }
   ```
3. レスポンスを監視する

**期待結果**:
- メッセージが正常に処理される
- 同じIDを持つレスポンスが返される
- レスポンスが正しい形式である

#### TC-WS-MSG-002: 無効なメッセージ形式

**目的**: 無効なメッセージ形式のエラー処理を確認する

**テストステップ**:
1. WebSocketサーバーに接続する
2. 以下の無効な形式のメッセージを送信する:
   ```json
   {
     "command": "ping"
   }
   ```
3. エラーレスポンスを監視する

**期待結果**:
- エラーレスポンスが返される
- エラーコードが「無効なメッセージ形式」を示している
- エラーの詳細が含まれている

### 5.2 コマンド処理テスト

#### TC-WS-CMD-001: 基本コマンド処理

**目的**: 基本的なコマンドが正しく処理されることを確認する

**テストステップ**:
1. WebSocketサーバーに接続する
2. 以下のコマンドメッセージを送信する:
   ```json
   {
     "type": "command",
     "command": "getStatus",
     "data": {},
     "id": "cmd-001"
   }
   ```
3. レスポンスを監視する

**期待結果**:
- コマンドが正常に処理される
- ステータス情報を含むレスポンスが返される
- レスポンスIDがリクエストIDと一致する

#### TC-WS-CMD-002: 未知のコマンド

**目的**: 未知のコマンドのエラー処理を確認する

**テストステップ**:
1. WebSocketサーバーに接続する
2. 存在しないコマンドを送信する:
   ```json
   {
     "type": "command",
     "command": "unknownCommand",
     "data": {},
     "id": "cmd-002"
   }
   ```
3. エラーレスポンスを監視する

**期待結果**:
- エラーレスポンスが返される
- エラーコードが「未知のコマンド」を示している
- エラーの詳細が含まれている

### 5.3 イベント通知テスト

#### TC-WS-EVENT-001: イベント購読

**目的**: イベント購読メカニズムが機能することを確認する

**テストステップ**:
1. WebSocketサーバーに接続する
2. 以下のイベント購読コマンドを送信する:
   ```json
   {
     "type": "command",
     "command": "subscribe",
     "data": {
       "events": ["memory.created", "memory.updated"]
     },
     "id": "sub-001"
   }
   ```
3. 購読確認レスポンスを監視する

**期待結果**:
- 購読コマンドが正常に処理される
- 購読確認レスポンスが返される
- 指定されたイベントの購読が確立される

#### TC-WS-EVENT-002: イベント通知受信

**目的**: イベント通知が正しく送信されることを確認する

**テストステップ**:
1. WebSocketサーバーに接続し、イベントを購読する
2. 別のクライアントまたはAPIを使用して記憶を作成する
3. イベント通知を監視する

**期待結果**:
- 記憶作成イベントの通知が受信される
- 通知が正しい形式である
- 通知に関連データが含まれている

## 6. 短期記憶操作テスト

### 6.1 短期記憶作成テスト

#### TC-WS-STM-001: WebSocketによる短期記憶作成

**目的**: WebSocketを介して短期記憶を作成できることを確認する

**テストステップ**:
1. WebSocketサーバーに接続する
2. 以下の短期記憶作成コマンドを送信する:
   ```json
   {
     "type": "command",
     "command": "memory.create",
     "data": {
       "memoryType": "shortTerm",
       "type": "OBSERVATION",
       "content": "WebSocketテスト短期記憶",
       "metadata": {
         "importance": 0.7,
         "confidence": 0.9,
         "contextId": "ctx-test-id",
         "tags": ["test", "websocket"]
       },
       "ttl": 3600
     },
     "id": "create-stm-001"
   }
   ```
3. レスポンスを監視する

**期待結果**:
- 短期記憶が正常に作成される
- 作成された記憶のIDを含むレスポンスが返される
- 記憶作成イベントが発行される

### 6.2 短期記憶検索テスト

#### TC-WS-STM-002: WebSocketによる短期記憶検索

**目的**: WebSocketを介して短期記憶を検索できることを確認する

**テストステップ**:
1. WebSocketサーバーに接続する
2. テスト用の短期記憶データを作成する
3. 以下の短期記憶検索コマンドを送信する:
   ```json
   {
     "type": "command",
     "command": "memory.search",
     "data": {
       "memoryType": "shortTerm",
       "query": "テスト",
       "limit": 10
     },
     "id": "search-stm-001"
   }
   ```
4. レスポンスを監視する

**期待結果**:
- 検索が正常に実行される
- 検索結果を含むレスポンスが返される
- 結果が関連性順にソートされている

## 7. リアルタイム記憶ストリーミングテスト

### 7.1 検索ストリーミングテスト

#### TC-WS-STREAM-001: 検索結果ストリーミング

**目的**: 検索結果がリアルタイムでストリーミングされることを確認する

**テストステップ**:
1. WebSocketサーバーに接続する
2. 以下の検索ストリーミングコマンドを送信する:
   ```json
   {
     "type": "command",
     "command": "memory.streamSearch",
     "data": {
       "query": "テスト",
       "includeShortTerm": true,
       "includeMidTerm": true,
       "includeLongTerm": true
     },
     "id": "stream-search-001"
   }
   ```
3. ストリーミングイベントを監視する

**期待結果**:
- ストリーミングが開始される
- 検索結果が見つかり次第、個別のイベントとして送信される
- 最終的にストリーミング完了イベントが送信される

#### TC-WS-STREAM-002: ストリーミングキャンセル

**目的**: 進行中のストリーミングをキャンセルできることを確認する

**テストステップ**:
1. WebSocketサーバーに接続する
2. 検索ストリーミングを開始する
3. 以下のストリーミングキャンセルコマンドを送信する:
   ```json
   {
     "type": "command",
     "command": "memory.cancelStream",
     "data": {
       "streamId": "stream-search-001"
     },
     "id": "cancel-stream-001"
   }
   ```
4. キャンセル確認とストリーミング終了イベントを監視する

**期待結果**:
- ストリーミングが正常にキャンセルされる
- キャンセル確認レスポンスが返される
- ストリーミング終了イベントが送信される

### 7.2 記憶更新ストリーミングテスト

#### TC-WS-STREAM-003: 記憶更新ストリーミング

**目的**: 記憶更新がリアルタイムでストリーミングされることを確認する

**テストステップ**:
1. WebSocketサーバーに接続する
2. 以下の記憶更新ストリーミングコマンドを送信する:
   ```json
   {
     "type": "command",
     "command": "memory.streamUpdates",
     "data": {
       "memoryTypes": ["shortTerm", "midTerm"],
       "eventTypes": ["created", "updated", "deleted"]
     },
     "id": "stream-updates-001"
   }
   ```
3. 別のクライアントを使用して記憶の作成、更新、削除を行う
4. 更新ストリーミングイベントを監視する

**期待結果**:
- ストリーミングが開始される
- 記憶の作成、更新、削除に応じてイベントが送信される
- イベントに関連データが含まれている

## 8. 記憶昇格テスト

### 8.1 WebSocketによる記憶昇格テスト

#### TC-WS-PROMOTE-001: 短期から中期への昇格

**目的**: WebSocketを介して短期記憶を中期記憶に昇格できることを確認する

**テストステップ**:
1. WebSocketサーバーに接続する
2. テスト用の短期記憶データを作成し、IDを取得する
3. 以下の記憶昇格コマンドを送信する:
   ```json
   {
     "type": "command",
     "command": "memory.promote",
     "data": {
       "sourceId": "取得したID",
       "targetType": "midTerm",
       "options": {
         "removeFromSource": false
       }
     },
     "id": "promote-001"
   }
   ```
4. レスポンスと昇格イベントを監視する

**期待結果**:
- 昇格が正常に実行される
- 新しい中期記憶のIDを含むレスポンスが返される
- 記憶昇格イベントが発行される

## 9. 同時接続テスト

### 9.1 複数クライアント接続テスト

#### TC-WS-MULTI-001: 複数クライアント同時接続

**目的**: 複数のクライアントが同時に接続できることを確認する

**テストステップ**:
1. 10個の異なるWebSocketクライアントを初期化する
2. すべてのクライアントを同時にサーバーに接続する
3. 各クライアントの接続状態を監視する

**期待結果**:
- すべてのクライアントが正常に接続される
- サーバーが複数の接続を適切に処理する
- システムパフォーマンスが許容範囲内である

### 9.2 ブロードキャストテスト

#### TC-WS-MULTI-002: イベントブロードキャスト

**目的**: イベントが複数のクライアントに正しくブロードキャストされることを確認する

**テストステップ**:
1. 複数のWebSocketクライアントを接続する
2. すべてのクライアントで同じイベントを購読する
3. イベントをトリガーする操作を実行する
4. 各クライアントのイベント受信を監視する

**期待結果**:
- すべての購読クライアントがイベントを受信する
- イベントの内容が一貫している
- イベント配信の遅延が許容範囲内である

## 10. エラー処理テスト

### 10.1 無効なコマンドパラメータテスト

#### TC-WS-ERROR-001: 無効なコマンドパラメータ

**目的**: 無効なコマンドパラメータのエラー処理を確認する

**テストステップ**:
1. WebSocketサーバーに接続する
2. 必須パラメータが欠けているコマンドを送信する:
   ```json
   {
     "type": "command",
     "command": "memory.create",
     "data": {
       "memoryType": "shortTerm"
       // contentが欠けている
     },
     "id": "error-001"
   }
   ```
3. エラーレスポンスを監視する

**期待結果**:
- エラーレスポンスが返される
- エラーコードが「無効なパラメータ」を示している
- どのパラメータが欠けているかが示されている

### 10.2 サーバーエラーテスト

#### TC-WS-ERROR-002: サーバー内部エラー処理

**目的**: サーバー内部エラーの処理を確認する

**テストステップ**:
1. WebSocketサーバーに接続する
2. サーバー内部エラーを引き起こすコマンドを送信する（テスト用のエラートリガーエンドポイントを使用）
3. エラーレスポンスを監視する

**期待結果**:
- エラーレスポンスが返される
- エラーコードが「サーバーエラー」を示している
- 接続が維持される
- エラーがサーバーログに記録される

## 11. パフォーマンステスト

### 11.1 高頻度メッセージテスト

#### TC-WS-PERF-001: 高頻度メッセージ処理

**目的**: 高頻度のメッセージ処理性能を評価する

**テストステップ**:
1. WebSocketサーバーに接続する
2. 1秒間に100件のpingコマンドを送信する
3. レスポンス時間と成功率を測定する

**期待結果**:
- すべてのメッセージが処理される
- 平均レスポンス時間が50ms以下である
- エラーが発生しない

### 11.2 長時間接続テスト

#### TC-WS-PERF-002: 長時間接続安定性

**目的**: 長時間接続の安定性を評価する

**テストステップ**:
1. WebSocketサーバーに接続する
2. 1時間接続を維持する
3. 定期的にpingコマンドを送信する
4. 接続状態とレスポンスを監視する

**期待結果**:
- 接続が1時間安定して維持される
- すべてのpingコマンドが正常に応答を返す
- メモリリークが発生しない

## 12. セキュリティテスト

### 12.1 認証トークン有効期限テスト

#### TC-WS-SEC-001: 認証トークン有効期限

**目的**: 認証トークンの有効期限切れ処理を確認する

**テストステップ**:
1. 短い有効期限（30秒）を持つ認証トークンを生成する
2. そのトークンを使用してWebSocketサーバーに接続する
3. 有効期限が切れるまで待機する
4. 接続状態と再認証イベントを監視する

**期待結果**:
- トークン有効期限切れ通知が送信される
- クライアントが再認証を要求される
- 再認証が行われない場合、一定時間後に接続が終了する

### 12.2 権限検証テスト

#### TC-WS-SEC-002: 操作権限検証

**目的**: 操作権限の検証が機能することを確認する

**テストステップ**:
1. 制限された権限を持つ認証トークンを生成する
2. そのトークンを使用してWebSocketサーバーに接続する
3. 権限外の操作（例：管理者専用コマンド）を試みる
4. エラーレスポンスを監視する

**期待結果**:
- エラーレスポンスが返される
- エラーコードが「権限不足」を示している
- 操作が実行されない

## 13. テスト実行計画

### 13.1 テスト実行順序

1. **接続管理テスト**
   - 接続確立テスト
   - 接続維持テスト
   - 接続終了テスト

2. **メッセージ処理テスト**
   - メッセージ形式テスト
   - コマンド処理テスト
   - イベント通知テスト

3. **記憶操作テスト**
   - 短期記憶操作テスト
   - リアルタイム記憶ストリーミングテスト
   - 記憶昇格テスト

4. **同時接続テスト**
   - 複数クライアント接続テスト
   - ブロードキャストテスト

5. **エラー処理テスト**
   - 無効なコマンドパラメータテスト
   - サーバーエラーテスト

6. **パフォーマンステスト**
   - 高頻度メッセージテスト
   - 長時間接続テスト

7. **セキュリティテスト**
   - 認証トークン有効期限テスト
   - 権限検証テスト

### 13.2 テスト自動化

1. **Jestテストスイート**
   - Socket.IOクライアントを使用したテスト
   - 自動接続・切断処理

2. **負荷テストツール**
   - 複数クライアントシミュレーション
   - パフォーマンス測定

3. **CI/CD統合**
   - GitHubアクションでの自動テスト
   - 定期的な長時間安定性テスト

## 14. 結論

WebSocket APIテストは、HARCA多階層記憶システムのリアルタイム通信機能が設計通りに機能し、各記憶モジュールと適切に連携することを確認するための重要なステップです。本ドキュメントで定義されたテストケースと実行計画に従ってテストを実施することで、WebSocket APIの信頼性、パフォーマンス、セキュリティを確保します。

リアルタイムの双方向通信機能は、特にユーザーエクスペリエンスと即時性が重要なアプリケーションシナリオにおいて、システムの価値を大きく高めます。テスト結果は、APIの品質評価と次のフェーズへの移行判断の基礎となります。
