---
title: "多階層記憶システム RESTful API テスト"
date: "2025-03-23"
author: "HARCA開発チーム"
version: "1.0.0"
status: "ドラフト"
---

# 多階層記憶システム RESTful API テスト

*作成日: 2025年3月23日*
*更新日: 2025年3月23日*

## 1. 概要

本ドキュメントでは、HARCA多階層記憶システムのRESTful APIに対する統合テストについて詳細に記述します。このテストは、APIエンドポイントが設計通りに機能し、各記憶モジュールと適切に連携することを確認することを目的としています。

## 2. テスト対象

### 2.1 RESTful APIエンドポイント

1. **短期記憶API**
   - `GET /api/v1/memory/short-term/{memoryId}`
   - `POST /api/v1/memory/short-term`
   - `PUT /api/v1/memory/short-term/{memoryId}`
   - `DELETE /api/v1/memory/short-term/{memoryId}`

2. **中期記憶API**
   - `GET /api/v1/memory/mid-term/{memoryId}`
   - `POST /api/v1/memory/mid-term`
   - `PUT /api/v1/memory/mid-term/{memoryId}`
   - `DELETE /api/v1/memory/mid-term/{memoryId}`

3. **長期記憶API**
   - `GET /api/v1/memory/long-term/{itemId}`
   - `POST /api/v1/memory/long-term`
   - `PUT /api/v1/memory/long-term/{itemId}`
   - `DELETE /api/v1/memory/long-term/{itemId}`

4. **検索API**
   - `GET /api/v1/memory/search`

5. **記憶昇格API**
   - `POST /api/v1/memory/promote/short-to-mid`
   - `POST /api/v1/memory/promote/mid-to-long`

## 3. テスト環境

### 3.1 テスト環境構成

- **APIサーバー**: Node.js v18.0+, Express v4.18+
- **データベース**:
  - Redis v7.0+ (短期記憶)
  - PostgreSQL v15.0+ (中期・長期記憶)
  - pgvector拡張 (ベクトル検索)
- **テストツール**:
  - Supertest v6.0+
  - Jest v29.0+
  - Postman v10.0+

### 3.2 テストデータ

- 各記憶層のテストデータ
- 様々なタイプとメタデータを持つ記憶データ
- エッジケースとバウンダリケース用のデータ

### 3.3 テスト前提条件

- APIサーバーが稼働していること
- データベースが適切に初期化されていること
- テスト用の認証トークンが利用可能であること

## 4. 短期記憶APIテスト

### 4.1 短期記憶取得テスト

#### TC-REST-STM-001: 有効なIDによる短期記憶取得

**目的**: 有効なIDを使用して短期記憶を取得できることを確認する

**テストステップ**:
1. テスト用の短期記憶データを作成し、IDを取得する
2. `GET /api/v1/memory/short-term/{memoryId}`エンドポイントを呼び出す
3. レスポンスのステータスコードとボディを検証する

**期待結果**:
- ステータスコード: 200 OK
- レスポンスボディ: 作成した短期記憶データと一致する
- 適切なContent-Typeヘッダーが設定されている

#### TC-REST-STM-002: 無効なIDによる短期記憶取得

**目的**: 無効なIDを使用した場合のエラー処理を確認する

**テストステップ**:
1. 存在しない短期記憶IDを生成する
2. `GET /api/v1/memory/short-term/{memoryId}`エンドポイントを呼び出す
3. レスポンスのステータスコードとエラーメッセージを検証する

**期待結果**:
- ステータスコード: 404 Not Found
- エラーメッセージ: 指定されたIDの記憶が見つからないことを示す
- 適切なエラーコードが含まれている

### 4.2 短期記憶作成テスト

#### TC-REST-STM-003: 有効なデータによる短期記憶作成

**目的**: 有効なデータを使用して短期記憶を作成できることを確認する

**テストステップ**:
1. 有効な短期記憶データを準備する
2. `POST /api/v1/memory/short-term`エンドポイントを呼び出す
3. レスポンスのステータスコードとボディを検証する
4. 作成された記憶が取得可能であることを確認する

**期待結果**:
- ステータスコード: 201 Created
- レスポンスボディ: 作成された記憶のIDと作成日時を含む
- Locationヘッダーに新しいリソースのURLが含まれている
- 作成された記憶が取得可能である

#### TC-REST-STM-004: 無効なデータによる短期記憶作成

**目的**: 無効なデータを使用した場合のエラー処理を確認する

**テストステップ**:
1. 必須フィールドが欠けている短期記憶データを準備する
2. `POST /api/v1/memory/short-term`エンドポイントを呼び出す
3. レスポンスのステータスコードとエラーメッセージを検証する

**期待結果**:
- ステータスコード: 400 Bad Request
- エラーメッセージ: 無効なデータであることを示す
- どのフィールドが無効か具体的に示されている

### 4.3 短期記憶更新テスト

#### TC-REST-STM-005: 有効なデータによる短期記憶更新

**目的**: 有効なデータを使用して短期記憶を更新できることを確認する

**テストステップ**:
1. テスト用の短期記憶データを作成し、IDを取得する
2. 更新用のデータを準備する
3. `PUT /api/v1/memory/short-term/{memoryId}`エンドポイントを呼び出す
4. レスポンスのステータスコードとボディを検証する
5. 更新された記憶が取得可能であることを確認する

**期待結果**:
- ステータスコード: 200 OK
- レスポンスボディ: 更新された記憶のIDと更新日時を含む
- 更新された記憶が取得可能であり、変更が反映されている

#### TC-REST-STM-006: 部分的なデータによる短期記憶更新

**目的**: 一部のフィールドのみを更新できることを確認する

**テストステップ**:
1. テスト用の短期記憶データを作成し、IDを取得する
2. 一部のフィールドのみを含む更新用データを準備する
3. `PUT /api/v1/memory/short-term/{memoryId}`エンドポイントを呼び出す
4. レスポンスのステータスコードとボディを検証する
5. 更新された記憶が取得可能であることを確認する

**期待結果**:
- ステータスコード: 200 OK
- 指定したフィールドのみが更新され、他のフィールドは元の値を保持している
- 更新日時が適切に更新されている

### 4.4 短期記憶削除テスト

#### TC-REST-STM-007: 有効なIDによる短期記憶削除

**目的**: 有効なIDを使用して短期記憶を削除できることを確認する

**テストステップ**:
1. テスト用の短期記憶データを作成し、IDを取得する
2. `DELETE /api/v1/memory/short-term/{memoryId}`エンドポイントを呼び出す
3. レスポンスのステータスコードとボディを検証する
4. 削除された記憶が取得できないことを確認する

**期待結果**:
- ステータスコード: 200 OK
- レスポンスボディ: 削除成功を示す情報を含む
- 削除された記憶IDで取得を試みると404エラーが返される

#### TC-REST-STM-008: 無効なIDによる短期記憶削除

**目的**: 無効なIDを使用した場合のエラー処理を確認する

**テストステップ**:
1. 存在しない短期記憶IDを生成する
2. `DELETE /api/v1/memory/short-term/{memoryId}`エンドポイントを呼び出す
3. レスポンスのステータスコードとエラーメッセージを検証する

**期待結果**:
- ステータスコード: 404 Not Found
- エラーメッセージ: 指定されたIDの記憶が見つからないことを示す
- 適切なエラーコードが含まれている

## 5. 中期記憶APIテスト

### 5.1 中期記憶取得テスト

#### TC-REST-MTM-001: 有効なIDによる中期記憶取得

**目的**: 有効なIDを使用して中期記憶を取得できることを確認する

**テストステップ**:
1. テスト用の中期記憶データを作成し、IDを取得する
2. `GET /api/v1/memory/mid-term/{memoryId}`エンドポイントを呼び出す
3. レスポンスのステータスコードとボディを検証する

**期待結果**:
- ステータスコード: 200 OK
- レスポンスボディ: 作成した中期記憶データと一致する
- アクセスカウントが増加している

### 5.2 中期記憶作成テスト

#### TC-REST-MTM-002: 有効なデータによる中期記憶作成

**目的**: 有効なデータを使用して中期記憶を作成できることを確認する

**テストステップ**:
1. 有効な中期記憶データを準備する
2. `POST /api/v1/memory/mid-term`エンドポイントを呼び出す
3. レスポンスのステータスコードとボディを検証する
4. 作成された記憶が取得可能であることを確認する

**期待結果**:
- ステータスコード: 201 Created
- レスポンスボディ: 作成された記憶のIDと作成日時を含む
- 作成された記憶が取得可能である
- 有効期限が適切に設定されている

## 6. 長期記憶APIテスト

### 6.1 長期記憶取得テスト

#### TC-REST-LTM-001: 有効なIDによる長期記憶取得

**目的**: 有効なIDを使用して長期記憶を取得できることを確認する

**テストステップ**:
1. テスト用の長期記憶データを作成し、IDを取得する
2. `GET /api/v1/memory/long-term/{itemId}`エンドポイントを呼び出す
3. レスポンスのステータスコードとボディを検証する

**期待結果**:
- ステータスコード: 200 OK
- レスポンスボディ: 作成した長期記憶データと一致する
- アクセスカウントが増加している

### 6.2 長期記憶作成テスト

#### TC-REST-LTM-002: 有効なデータによる長期記憶作成

**目的**: 有効なデータを使用して長期記憶を作成できることを確認する

**テストステップ**:
1. 有効な長期記憶データを準備する
2. `POST /api/v1/memory/long-term`エンドポイントを呼び出す
3. レスポンスのステータスコードとボディを検証する
4. 作成された記憶が取得可能であることを確認する

**期待結果**:
- ステータスコード: 201 Created
- レスポンスボディ: 作成された記憶のIDと作成日時を含む
- 作成された記憶が取得可能である

## 7. 検索APIテスト

### 7.1 基本検索テスト

#### TC-REST-SEARCH-001: テキスト検索

**目的**: テキストクエリに基づく検索機能を確認する

**テストステップ**:
1. 各記憶層に検索可能なテストデータを作成する
2. テキストクエリを指定して`GET /api/v1/memory/search?query={query}`エンドポイントを呼び出す
3. レスポンスのステータスコードとボディを検証する

**期待結果**:
- ステータスコード: 200 OK
- レスポンスボディ: クエリに関連する記憶データのリストを含む
- 結果が関連性に基づいて順序付けられている
- 各記憶層からの結果が含まれている

#### TC-REST-SEARCH-002: フィルタリング検索

**目的**: 複数のフィルタを適用した検索機能を確認する

**テストステップ**:
1. 様々なタイプとタグを持つテストデータを作成する
2. フィルタを指定して`GET /api/v1/memory/search?query={query}&memoryTypes={types}&tags={tags}`エンドポイントを呼び出す
3. レスポンスのステータスコードとボディを検証する

**期待結果**:
- ステータスコード: 200 OK
- レスポンスボディ: 指定されたフィルタに一致する記憶データのみを含む
- 結果が関連性に基づいて順序付けられている

### 7.2 高度な検索テスト

#### TC-REST-SEARCH-003: コンテキスト依存検索

**目的**: コンテキストに基づく検索結果の調整を確認する

**テストステップ**:
1. 各記憶層にテストデータを作成する
2. コンテキストIDを指定して`GET /api/v1/memory/search?query={query}&contextId={contextId}`エンドポイントを呼び出す
3. レスポンスのステータスコードとボディを検証する

**期待結果**:
- ステータスコード: 200 OK
- レスポンスボディ: 指定されたコンテキストに関連する記憶データが優先されている
- 結果が関連性に基づいて順序付けられている

## 8. 記憶昇格APIテスト

### 8.1 短期→中期記憶昇格テスト

#### TC-REST-PROMOTE-001: 短期から中期への昇格

**目的**: 短期記憶から中期記憶への昇格機能を確認する

**テストステップ**:
1. テスト用の短期記憶データを作成し、IDを取得する
2. `POST /api/v1/memory/promote/short-to-mid`エンドポイントを呼び出し、短期記憶IDを指定する
3. レスポンスのステータスコードとボディを検証する
4. 中期記憶が作成されていることを確認する
5. 短期記憶の状態を確認する（削除オプションによる）

**期待結果**:
- ステータスコード: 200 OK
- レスポンスボディ: 元の短期記憶IDと新しい中期記憶IDを含む
- 中期記憶が正しく作成され、短期記憶のデータが適切に変換されている
- 短期記憶は削除オプションに応じて保持または削除されている

### 8.2 中期→長期記憶昇格テスト

#### TC-REST-PROMOTE-002: 中期から長期への昇格

**目的**: 中期記憶から長期記憶への昇格機能を確認する

**テストステップ**:
1. テスト用の中期記憶データを作成し、IDを取得する
2. `POST /api/v1/memory/promote/mid-to-long`エンドポイントを呼び出し、中期記憶IDを指定する
3. レスポンスのステータスコードとボディを検証する
4. 長期記憶が作成されていることを確認する
5. 中期記憶の状態を確認する

**期待結果**:
- ステータスコード: 200 OK
- レスポンスボディ: 元の中期記憶IDと新しい長期記憶IDを含む
- 長期記憶が正しく作成され、中期記憶のデータが適切に変換・一般化されている
- 中期記憶と長期記憶の間にリンクが確立されている

## 9. エラー処理テスト

### 9.1 認証エラーテスト

#### TC-REST-ERROR-001: 認証トークンなしのアクセス

**目的**: 認証トークンなしでのAPIアクセス時のエラー処理を確認する

**テストステップ**:
1. 認証トークンなしで各APIエンドポイントを呼び出す
2. レスポンスのステータスコードとエラーメッセージを検証する

**期待結果**:
- ステータスコード: 401 Unauthorized
- エラーメッセージ: 認証が必要であることを示す
- 適切なWWW-Authenticateヘッダーが設定されている

### 9.2 バリデーションエラーテスト

#### TC-REST-ERROR-002: 無効なデータ形式

**目的**: 無効なデータ形式でのリクエスト時のエラー処理を確認する

**テストステップ**:
1. 無効なJSON形式のデータを準備する
2. 各POSTエンドポイントを呼び出す
3. レスポンスのステータスコードとエラーメッセージを検証する

**期待結果**:
- ステータスコード: 400 Bad Request
- エラーメッセージ: 無効なデータ形式であることを示す
- 具体的なエラー位置が示されている

### 9.3 サーバーエラーテスト

#### TC-REST-ERROR-003: データベース接続エラー

**目的**: データベース接続エラー時のエラー処理を確認する

**テストステップ**:
1. データベース接続を一時的に切断する（モックまたは実際の切断）
2. 各APIエンドポイントを呼び出す
3. レスポンスのステータスコードとエラーメッセージを検証する

**期待結果**:
- ステータスコード: 500 Internal Server Error
- エラーメッセージ: 内部サーバーエラーであることを示す
- 詳細なエラー情報は本番環境では隠蔽されている

## 10. テスト実行計画

### 10.1 テスト実行順序

1. **基本CRUD操作テスト**
   - 短期記憶API
   - 中期記憶API
   - 長期記憶API

2. **検索・昇格テスト**
   - 検索API
   - 記憶昇格API

3. **エラー処理テスト**
   - 認証エラー
   - バリデーションエラー
   - サーバーエラー

### 10.2 テスト自動化

1. **Jestテストスイート**
   - 各テストケースをJestで実装
   - Supertestを使用したHTTPリクエスト

2. **Postmanコレクション**
   - 手動テスト用のPostmanコレクション
   - 環境変数を使用した柔軟なテスト

3. **CI/CD統合**
   - GitHubアクションでの自動テスト
   - テスト結果レポートの生成

## 11. 結論

RESTful APIテストは、HARCA多階層記憶システムのAPIが設計通りに機能し、各記憶モジュールと適切に連携することを確認するための重要なステップです。本ドキュメントで定義されたテストケースと実行計画に従ってテストを実施することで、APIの信頼性と一貫性を確保します。

テスト結果は、APIの品質評価と次のフェーズへの移行判断の基礎となります。また、テスト中に発見された問題や改善点は、APIの継続的な改善に活用されます。
