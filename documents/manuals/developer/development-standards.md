# HARCA プロジェクト 開発標準

このドキュメントは、HARCAプロジェクトの開発標準を定義します。
一貫性のある開発環境と効率的な開発プロセスを確保するために、すべての開発者はこれらの標準に従ってください。

## パッケージマネージャー

HARCAプロジェクトでは、**pnpm**をパッケージマネージャーとして使用します。

- **使用すべき**: pnpm
- **使用しないでください**: npm, yarn

### 理由

- pnpmはディスク容量を節約する効率的なパッケージ管理を提供します
- 厳格な依存関係管理により、「幽霊依存関係」の問題を回避します
- より高速なインストールとビルド時間を実現します
- モノレポ構造に優れたサポートを提供します

## コマンド実行

- パッケージのインストール: `pnpm install`
- スクリプト実行: `pnpx <script>` または `pnpm exec <script>`
- 開発サーバーの起動: `pnpm dev`
- テストの実行: `pnpm test`
- ビルド: `pnpm build`

## package.json の設定

すべての`package.json`ファイルでは、スクリプトセクションで以下の規則に従ってください：

```json
{
  "scripts": {
    "dev": "node server.js",
    "test": "pnpm exec jest",
    "lint": "pnpm exec eslint .",
    "build": "node build.js"
  }
}
```

## 依存関係の管理

- 新しい依存関係の追加: `pnpm add <package-name>`
- 開発依存関係の追加: `pnpm add -D <package-name>`
- グローバル依存関係の追加: `pnpm add -g <package-name>`
- 依存関係の更新: `pnpm update`
- 未使用の依存関係の確認: `pnpm prune`

## 環境変数

環境変数は`.env`ファイルで管理します。プロジェクトルートの`.env.example`ファイルをコピーして使用してください。

主な環境変数：
- `SUPABASE_CONNECTION_STRING`: PostgreSQL接続文字列
- `REDIS_URL`: Redis接続URL
- `CACHE_TTL`: キャッシュエントリのTTL（秒）
- `CACHE_PREFIX`: Redisキーのプレフィックス
- `ENABLE_MEMORY_CACHE`: メモリキャッシュの有効化
- `ENABLE_REDIS_CACHE`: Redisキャッシュの有効化
- `ENABLE_FILE_CACHE`: ファイルキャッシュの有効化

## ポート設定

一貫性を保ち、ポートの衝突を避けるために、すべてのHARCA関連サービスは3700番台のポートを使用します。

### ポート割り当て

| サービス | ポート | 環境変数 | 説明 |
|---------|------|---------|------|
| キャッシュダッシュボード | 3700 | CACHE_DASHBOARD_PORT | 埋め込みキャッシュのパフォーマンスを監視するためのWebインターフェース |
| ベクトルストアAPI | 3701 | VECTOR_STORE_API_PORT | ベクトル検索APIエンドポイント |
| 管理コンソール | 3702 | ADMIN_CONSOLE_PORT | システム管理用Webインターフェース |
| デバッグサーバー | 3703 | DEBUG_SERVER_PORT | デバッグ情報提供用サーバー |
| テストサーバー | 3704 | TEST_SERVER_PORT | 自動テスト実行用サーバー |
| モニタリングサービス | 3705 | MONITORING_SERVICE_PORT | システム監視サービス |
| ドキュメント生成サービス | 3706 | DOC_SERVICE_PORT | APIドキュメント生成サービス |
| 開発サーバー | 3707 | DEV_SERVER_PORT | ローカル開発環境用サーバー |
| 予備 | 3708-3799 | - | 将来の拡張用 |

### 使用方法

新しいサービスを追加する際は、このドキュメントを更新し、未使用のポート番号を割り当ててください。
すべてのサービスは、デフォルトでここに記載されているポート番号を使用するように設定してください。

### 注意事項

- ポート番号の変更が必要な場合は、このドキュメントを更新してください
- 開発環境と本番環境で同じポート番号を使用することを推奨します
- ポート衝突を避けるため、他のアプリケーションでは3700番台のポートを使用しないでください

## コーディング規約

- ESLintとPrettierを使用してコードスタイルを統一します
- コードレビュー前に`pnpm lint`と`pnpm test`を実行してください
- すべての新機能には対応するテストを作成してください
- コミットメッセージは日本語で記述し、変更内容を明確に説明してください

## ドキュメント

- 新機能を追加する際は、対応するドキュメントも更新してください
- APIエンドポイントには適切なJSDocコメントを追加してください
- 複雑なロジックには説明コメントを追加してください
- プロジェクト記録の作成時には、マスタードキュメントも同時に更新してください

## ドキュメント更新プロセス

HARCAプロジェクトでは、以下のドキュメント更新スクリプトを使用します：

1. **プロジェクト記録の作成**:
   ```bash
   pnpm run create-log-entry
   ```

2. **マスタードキュメントの更新**:
   ```bash
   pnpm run update-master-document
   ```

3. **すべてのドキュメントの更新**:
   ```bash
   pnpm run update-all-docs
   ```

## 継続的インテグレーション

- プルリクエストを作成する前に、すべてのテストが通過することを確認してください
- マージ前にコードレビューを受けてください
- 本番環境へのデプロイ前に、ステージング環境でテストしてください
